#!/usr/bin/env Rscript

# RMP_calc.R from mPCRselect version 0.3.0
# Ellie E. Armstrong and Michael G. Campana, 2024
# Stanford University and Smithsonian Institution

# CC0: To the extent possible under law, the Smithsonian Institution and Stanford 
# University have waived all copyright and related or neighboring rights to mPCRselect;
# this work is published from the United States. You should have received a copy of the
# CC0 legal code along with this work. If not, see 
# <http://creativecommons.org/publicdomain/zero/1.0/>.

# We politely request that this work be cited as:
# Armstrong EE, Li C, Campana MG, Ferrari T, Kelley JL, Petrov DA, Solari KA, Mooney JA.
# In prep. Recommendations for population and individual diagnostic SNP selection in non-
# model species.

###Code for calculating RMP from allele frequencies
library(tidyr) # Part of tidyverse
library(dplyr) # Part of tidyverse

#read in freq file from vcftools, generated by vcftools --gzvcf ${bn}.vcf.gz --freq --out ${bn}
args = commandArgs(trailingOnly=TRUE)
freq_allele <- read.table(args, sep = '\t')

#modify header
freq_allele <- freq_allele %>%
  rename(chr=V1, position=V2, N_Alleles=V3,N_Chr=V4) %>%
  tidyr::separate(V5, into = c("Allele_ID1", "Allele_ID1_freq"), sep = ":") %>%
  tidyr::separate(V6, into = c("Allele_ID2", "Allele_ID2_freq"), sep = ":")

#calculate genotype frequences as p^2, q^2, or 2pq (assuming HWE)
freq_allele <- freq_allele %>%
  mutate(refhom_geno_freq = (as.numeric(Allele_ID1_freq)^2)) %>%
  mutate(althom_geno_freq = (as.numeric(Allele_ID2_freq)^2)) %>%
  mutate(het_geno_freq = (2*as.numeric(Allele_ID1_freq) * as.numeric(Allele_ID2_freq)))

#find maximum and minimum of three calculated genotype frequencies to compute RMP min and max
freq_allele <- freq_allele %>% 
  rowwise() %>% 
  mutate(max = max(refhom_geno_freq, althom_geno_freq, het_geno_freq)) %>%
  mutate(min = min(refhom_geno_freq, althom_geno_freq, het_geno_freq))

#calculate maximum and minimum RMP (product of genotype frequences across profile)
RMP_max = prod(freq_allele$max)
print(paste("RMP Max:", RMP_max))

RMP_min = prod(freq_allele$min)
print(paste("RMP Min:", RMP_min))
